<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LangGraph Agent POC</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background: #1f1f1f;
            padding: 10px 20px;
            font-size: 1.5rem;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 10px;
            padding: 10px;
            flex: 1;
            overflow: hidden;
        }
        section {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 6px;
            overflow-y: auto;
        }
        h2 {
            margin: 0 0 10px 0;
            color: #ffffff;
            font-size: 1.2rem;
        }
        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        li {
            background: #2a2a2a;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .chat-bubble {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
        }
        .user {
            background: #3b82f6;
            color: #fff;
        }
        .agent {
            background: #2e2e2e;
            color: #d0d0d0;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            background: #2e2e2e;
            color: #e0e0e0;
            border: none;
            border-radius: 5px;
        }
        .input-group button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <header>LangGraph Agent POC</header>
    <main>
        <section>
            <h2>Uploaded Files & OCR Text</h2>
            <form id="upload-form" enctype="multipart/form-data">
                <input type="file" name="file" />
                <button type="submit">Upload</button>
            </form>
            <ul id="file-list"></ul>
        </section>

        <section>
            <h2>Available Tools & Tutorial</h2>
            <div id="tools-info"></div>
        </section>

        <section style="grid-column: span 2; display: flex; flex-direction: column;">
            <h2>Chat</h2>
            <form id="chat-form">
                <div class="input-group">
                    <input type="text" id="chat-input" name="query" placeholder="Ask something..." required />
                    <button type="submit">Send</button>
                </div>
            </form>
            <div id="chat-history" style="flex: 1; overflow-y: auto; margin-top: 10px;"></div>
        </section>
    </main>

    <script>
        let chatHistory = [];

        async function refreshFileList() {
            const response = await fetch('/uploaded_files');
            const result = await response.json();
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            result.forEach(fileEntry => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${fileEntry.filename}</strong><br><pre>${fileEntry.ocr_text.slice(0, 300)}${fileEntry.ocr_text.length > 300 ? '...' : ''}</pre>`;
                fileList.appendChild(li);
            });
        }

        async function loadTools() {
            const response = await fetch('/available_tools');
            const result = await response.json();
            const toolsInfo = document.getElementById('tools-info');

            let html = "<ul>";
            for (const [tool, desc] of Object.entries(result.tools)) {
                html += `<li><strong>${tool}</strong>: ${desc}</li>`;
            }
            html += "</ul>";

            html += "<h3>How to Use</h3><ul>";
            html += "<li><b>OCR Example:</b> 'Using your OCR tools, tell me what the contents of image.png are.'</li>";
            html += "<li><b>OCR Tips:</b> 'OCR currently looks for exact file names. Asking for the tool specifically will help.'</li>";
            html += "<li><b>Dealer Risk Example:</b> 'What is the viper risk score for dealer_id 12345?'</li>";
            html += "<li><b>Dealer Risk Tips:</b> 'Dealer Risk currently looks for dealer_id or lotname.  Asking for the tool specifically will help.'</li>";
            html += "<li><b>LLM Example:</b> 'Explain what a floorplan loan is.'</li>";
            html += "<li><b>LLM Tips:</b> 'LLM currently uses the Mistral model.  Asking for the tool specifically will help.'</li>";
            html += "<li><b>Research Example:</b> 'What is the latest news on the stock market? Use the research tool.'</li>";
            html += "</ul>";

            toolsInfo.innerHTML = html;
        }

        function renderChatHistory() {
            const historyDiv = document.getElementById('chat-history');
            historyDiv.innerHTML = '';
            chatHistory.forEach(entry => {
                const userDiv = document.createElement('div');
                userDiv.className = 'chat-bubble user';
                userDiv.innerHTML = `<strong>You:</strong> ${entry.user}`;
                historyDiv.appendChild(userDiv);

                const agentDiv = document.createElement('div');
                agentDiv.className = 'chat-bubble agent';
                agentDiv.innerHTML = `<strong>Agent:</strong> ${entry.assistant}`;
                historyDiv.appendChild(agentDiv);
            });
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        async function sendChat(e) {
            e.preventDefault();
            const query = document.getElementById('chat-input').value;
            if (!query) return;

            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query, history: chatHistory })
            });

            const result = await response.json();
            chatHistory.push({ user: query, assistant: result.response });
            renderChatHistory();

            document.getElementById('chat-input').value = '';
        }

        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const response = await fetch('/upload_file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            alert(`Uploaded: ${result.filename}`);
            refreshFileList();
        });

        document.getElementById('chat-form').addEventListener('submit', sendChat);
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChat(e);
            }
        });

        window.onload = () => {
            refreshFileList();
            loadTools();
        };
    </script>
</body>
</html>
